/*
    DROP TABLE
*/
DROP TABLE USER_ROLE_ACCESS_CONDITIONS PURGE;
DROP TABLE DANGKY CASCADE CONSTRAINTS;
DROP TABLE PHANCONG CASCADE CONSTRAINTS;
DROP TABLE KHMO CASCADE CONSTRAINTS;
DROP TABLE HOCPHAN CASCADE CONSTRAINTS;
DROP TABLE DONVI CASCADE CONSTRAINTS;
DROP TABLE NHANSU CASCADE CONSTRAINTS;
DROP TABLE SINHVIEN CASCADE CONSTRAINTS;

    
    
/*
    CREATE TABLE
*/
-- Tạo bảng chứa các cột mà user/role được cấp
CREATE TABLE USER_ROLE_ACCESS_CONDITIONS (
    USER_ROLE VARCHAR2(128),
    TABLE_NAME VARCHAR2(128),
    COLUMN_NAME VARCHAR2(128),
    CONSTRAINT PK_USER_ROLE_ACCESS_CONDITIONS PRIMARY KEY (USER_ROLE, TABLE_NAME, COLUMN_NAME)
)


CREATE TABLE SINHVIEN
(
    MASV CHAR(10) NOT NULL,
    HOTEN NVARCHAR2(50) NOT NULL,
    PHAI NVARCHAR2(5) NOT NULL,
    NGSINH DATE NOT NULL,
    DCHI NVARCHAR2(100) NOT NULL,
    SDT CHAR(10) NOT NULL,
    MACT CHAR(5) NOT NULL,
    MANGANH CHAR(10) NOT NULL,
    SOTCTL INT NOT NULL,
    DTBTL FLOAT NULL,
    CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV)
);

CREATE TABLE NHANSU
(
    MANV CHAR(10) NOT NULL,
    HOTEN NVARCHAR2(50) NOT NULL,
    PHAI NVARCHAR2(5) NOT NULL,
    NGSINH DATE NOT NULL,
    PHUCAP FLOAT NOT NULL,
    SDT CHAR(10) NOT NULL,
    VAITRO NVARCHAR2(20) NOT NULL,
    MADV CHAR(10) NULL,
    CONSTRAINT PK_NHANSU PRIMARY KEY (MANV)    
);

CREATE TABLE DONVI
(
    MADV CHAR(10) NOT NULL,
    TENDV NVARCHAR2(50) NOT NULL,
    TRUONGDV CHAR(10) NULL,
    CONSTRAINT PK_DONVI PRIMARY KEY (MADV)    
);

CREATE TABLE HOCPHAN
(
    MAHP CHAR(10) NOT NULL,
    TENHP NVARCHAR2(100) NOT NULL,
    SOTC INT NOT NULL,
    STLT INT NOT NULL,
    STTH INT NOT NULL,
    SOSVTD INT NOT NULL,
    MADV CHAR(10) NULL,
    CONSTRAINT PK_HOCPHAN PRIMARY KEY (MAHP)    
);

CREATE TABLE KHMO
(
    MAHP CHAR(10) NOT NULL,
    HK INT NOT NULL,
    NAM INT NOT NULL,
    MACT CHAR(5) NOT NULL,
    CONSTRAINT PK_KHMO PRIMARY KEY (HK, NAM, MACT, MAHP)    
);

CREATE TABLE PHANCONG
(
    MAGV CHAR(10) NOT NULL,
    MAHP CHAR(10) NOT NULL,
    HK INT NOT NULL,
    NAM INT NOT NULL,
    MACT CHAR(5) NOT NULL,
    CONSTRAINT PK_PHANCONG PRIMARY KEY (MAGV, HK, NAM, MACT, MAHP)    
);

CREATE TABLE DANGKY
(
    MASV CHAR(10) NOT NULL,
    MAGV CHAR(10) NOT NULL,
    MAHP CHAR(10) NOT NULL,
    HK INT NOT NULL,
    NAM INT NOT NULL,
    MACT CHAR(5) NOT NULL,
    DIEMTH FLOAT NULL,
    DIEMQT FLOAT NULL,
    DIEMCK FLOAT NULL,
    DIEMTK FLOAT NULL,
    CONSTRAINT PK_DANGKY PRIMARY KEY (MASV, MAGV, HK, NAM, MACT, MAHP)    
);

-- ADD CONSTRAINT
ALTER TABLE SINHVIEN
ADD CONSTRAINT FK_SINHVIEN_DONVI FOREIGN KEY (MANGANH) REFERENCES DONVI(MADV)
ADD CONSTRAINT C_SINHVIEN_MACT CHECK (MACT IN ('CQ', 'CLC', 'CTTT', 'VP'));

ALTER TABLE NHANSU
ADD CONSTRAINT FK_NHANSU_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
ADD CONSTRAINT C_NHANSU_VAITRO CHECK (VAITRO IN (N'Nhân viên cơ bản', N'Giảng viên', N'Giáo vụ', N'Trưởng đơn vị', N'Trưởng khoa'));
    
ALTER TABLE DONVI
ADD CONSTRAINT FK_DONVI_NHANSU FOREIGN KEY (TRUONGDV) REFERENCES NHANSU(MANV);
    
ALTER TABLE HOCPHAN
ADD CONSTRAINT FK_HOCPHAN_DONVI FOREIGN KEY (MADV) REFERENCES DONVI(MADV);
    
ALTER TABLE KHMO
ADD CONSTRAINT FK_KHMO_HOCPHAN FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP)
ADD CONSTRAINT C_KHMO_MACT CHECK (MACT IN ('CQ', 'CLC', 'CTTT', 'VP'));
    
ALTER TABLE PHANCONG
ADD CONSTRAINT FK_PHANCONG_NHANSU FOREIGN KEY (MAGV) REFERENCES NHANSU(MANV)
ADD CONSTRAINT FK_PHANCONG_KHMO FOREIGN KEY (HK, NAM, MACT, MAHP) REFERENCES KHMO(HK, NAM, MACT, MAHP);
    
ALTER TABLE DANGKY
ADD CONSTRAINT FK_DANGKY_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV)
ADD CONSTRAINT FK_DANGKY_PHANCONG FOREIGN KEY (MAGV, HK, NAM, MACT, MAHP) REFERENCES PHANCONG(MAGV, HK, NAM, MACT, MAHP);


