ALTER SESSION SET CONTAINER=ATTT; 
ALTER SESSION SET nls_date_format='dd-mm-yyyy';

-- Run with C##ADMIN --


/*
    DROP TABLE
*/
DROP TABLE QUANLY_NHANSU CASCADE CONSTRAINTS PURGE;

/*
    CREATE TABLE
*/
CREATE TABLE QUANLY_NHANSU
(
    MANV CHAR(10) NOT NULL,
    HOTEN NVARCHAR2(50) NOT NULL,
    PHAI NVARCHAR2(5) NOT NULL,
    NGSINH DATE NOT NULL,
    PHUCAP FLOAT NOT NULL,
    SDT CHAR(10) NOT NULL,
    VAITRO NVARCHAR2(20) NOT NULL,
    MADV CHAR(10) NULL,
    COSO CHAR(3),
    CONSTRAINT PK_QUANLY_NHANSU PRIMARY KEY (MANV)    
);

/*
    INSERT DATASET
*/
INSERT INTO QUANLY_NHANSU VALUES ('NV00000001', N'Dương Đoàn Phúc', N'Nữ', '07-11-1965', 921000, '0200000001', N'Trưởng khoa', 'VPK', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000002', N'Phan Đăng Hương', N'Nam', '20-03-1976', 837000, '0200000002', N'Trưởng đơn vị', 'HTTT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000003', N'Vũ Như Anh', N'Nữ', '27-04-1980', 893000, '0200000003', N'Trưởng đơn vị', 'CNPM', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000004', N'Lương Chính My', N'Nam', '23-09-1965', 559000, '0200000004', N'Trưởng đơn vị', 'KHMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000005', N'Đỗ Vương Thuỳ', N'Nữ', '01-07-1976', 824000, '0200000005', N'Trưởng đơn vị', 'CNTT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000006', N'Mai Đoàn Hương', N'Nam', '14-02-1964', 113000, '0200000006', N'Trưởng đơn vị', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000007', N'Đặng Minh Nam', N'Nam', '17-02-1967', 667000, '0200000007', N'Trưởng đơn vị', 'MMT', 'CS2');

INSERT INTO QUANLY_NHANSU VALUES ('NV00000028', N'Vương Vĩnh Tiên', N'Nữ', '29-12-1978', 158000, '0200000028', N'Giảng viên', 'KHMT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000029', N'Phan Chính Hương', N'Nữ', '30-05-1970', 781000, '0200000029', N'Giảng viên', 'MMT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000030', N'Đỗ Đoàn Vy', N'Nữ', '28-12-1968', 217000, '0200000030', N'Giảng viên', 'CNTT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000031', N'Bùi Vương Thịnh', N'Nam', '18-05-1974', 954000, '0200000031', N'Giảng viên', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000032', N'Trịnh Vĩnh Quỳnh', N'Nữ', '29-09-1971', 969000, '0200000032', N'Giảng viên', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000033', N'Lê Đăng My', N'Nam', '03-11-1979', 984000, '0200000033', N'Giảng viên', 'TGMT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000034', N'Nông Minh Khoa', N'Nữ', '18-10-1973', 782000, '0200000034', N'Giảng viên', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000035', N'Phan Như My', N'Nữ', '27-01-1985', 630000, '0200000035', N'Giảng viên', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000036', N'Hồ Chính My', N'Nam', '11-01-1978', 365000, '0200000036', N'Giảng viên', 'TGMT', 'CS1');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000037', N'Bạch Đoàn Kha', N'Nam', '07-04-1964', 725000, '0200000037', N'Giảng viên', 'MMT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000038', N'Đoàn Minh My', N'Nam', '13-11-1963', 685000, '0200000038', N'Giảng viên', 'KHMT', 'CS2');
INSERT INTO QUANLY_NHANSU VALUES ('NV00000039', N'Bạch Đăng Tiên', N'Nam', '23-01-1984', 866000, '0200000039', N'Giảng viên', 'KHMT', 'CS1');

GRANT CREATE SESSION TO OLS_ADMIN;
GRANT SELECT, UPDATE, INSERT, DELETE ON QUANLY_NHANSU TO OLS_ADMIN WITH GRANT OPTION;

CREATE OR REPLACE PROCEDURE USP_OLS_QUANLY(P_RES OUT SYS_REFCURSOR)
AS
BEGIN
     OPEN P_RES FOR
        SELECT MANV, HOTEN, PHAI, NGSINH, PHUCAP, SDT, VAITRO, MADV, COSO FROM QUANLY_NHANSU;
END;
/

GRANT EXECUTE ON USP_OLS_QUANLY TO RL_GIANGVIEN;


-- Run with OLS_ADMIN

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 260, label_value => 'TRUONGDV:MMT:CS1,CS2'); 
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 250, label_value => 'TRUONGDV:TGMT:CS1,CS2'); 
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 240, label_value => 'TRUONGDV:CNTT:CS1,CS2'); 
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 220, label_value => 'TRUONGDV:CNPM:CS1,CS2'); 
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 210, label_value => 'TRUONGDV:HTTT:CS1,CS2'); 

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 331, label_value => 'GIANGVIEN:KHMT:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 332, label_value => 'GIANGVIEN:KHMT:CS2');

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 361, label_value => 'GIANGVIEN:MMT:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 362, label_value => 'GIANGVIEN:MMT:CS2');

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 351, label_value => 'GIANGVIEN:TGMT:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 352, label_value => 'GIANGVIEN:TGMT:CS2');

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 341, label_value => 'GIANGVIEN:CNTT:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 342, label_value => 'GIANGVIEN:CNTT:CS2');

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 321, label_value => 'GIANGVIEN:CNPM:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 322, label_value => 'GIANGVIEN:CNPM:CS2');

EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 311, label_value => 'GIANGVIEN:HTTT:CS1');
EXECUTE SA_LABEL_ADMIN.CREATE_LABEL(policy_name => 'BRANCH_POLICY', label_tag => 312, label_value => 'GIANGVIEN:HTTT:CS2');


EXECUTE SA_POLICY_ADMIN.REMOVE_TABLE_POLICY('BRANCH_POLICY','C##ADMIN','QUANLY_NHANSU', TRUE);
EXECUTE SA_POLICY_ADMIN.APPLY_TABLE_POLICY (policy_name => 'BRANCH_POLICY', schema_name => 'C##ADMIN', table_name => 'QUANLY_NHANSU', table_options => 'NO_CONTROL'); 



UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGKHOA') WHERE MANV = 'NV00000001';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:HTTT:CS1,CS2') WHERE MANV = 'NV00000002';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:CNPM:CS1,CS2') WHERE MANV = 'NV00000003';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:KHMT:CS1,CS2') WHERE MANV = 'NV00000004';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:CNTT:CS1,CS2') WHERE MANV = 'NV00000005';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:TGMT:CS1,CS2') WHERE MANV = 'NV00000006';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'TRUONGDV:MMT:CS1,CS2') WHERE MANV = 'NV00000007';

UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:KHMT:CS2') WHERE MANV = 'NV00000028';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:MMT:CS2') WHERE MANV = 'NV00000029';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:CNTT:CS2') WHERE MANV = 'NV00000030';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS1') WHERE MANV = 'NV00000031';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS1') WHERE MANV = 'NV00000032';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS2') WHERE MANV = 'NV00000033';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS1') WHERE MANV = 'NV00000034';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS1') WHERE MANV = 'NV00000035';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:TGMT:CS1') WHERE MANV = 'NV00000036';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:MMT:CS2') WHERE MANV = 'NV00000037';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:KHMT:CS2') WHERE MANV = 'NV00000038';
UPDATE C##ADMIN.QUANLY_NHANSU SET BRANCH_LABEL = CHAR_TO_LABEL('BRANCH_POLICY', 'GIANGVIEN:KHMT:CS1') WHERE MANV = 'NV00000039';

EXECUTE SA_POLICY_ADMIN.REMOVE_TABLE_POLICY('BRANCH_POLICY','C##ADMIN','QUANLY_NHANSU');

BEGIN
    SA_POLICY_ADMIN.APPLY_TABLE_POLICY (
        policy_name => 'BRANCH_POLICY', 
        schema_name => 'C##ADMIN', 
        table_name => 'QUANLY_NHANSU', 
        table_options => 'LABEL_DEFAULT, READ_CONTROL, WRITE_CONTROL'
    );
END;
/